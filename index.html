<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–∑–≤—É—á–∫–∏ | –ú–∞–ª—é—Ç–∏–Ω Voice</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #1c1c1e;
      --text-color: #FFFCF2;
      --input-bg: #2c2c2e;
      --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --accent-color: #8b5cf6;
      --accent-light: #a78bfa;
      --radius: 12px;
      --radius-lg: 20px;
      --card-bg: rgba(44, 44, 46, 0.4);
      --card-border: rgba(255, 255, 255, 0.12);
      --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      font-family: 'Montserrat', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      overflow-x: hidden;
    }

    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      position: relative;
    }

    /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
    .animated-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      opacity: 0.3;
      pointer-events: none;
    }

    .wave {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .wave path {
      stroke: #667eea;
      stroke-width: 1;
      fill: none;
      filter: drop-shadow(0 0 6px #764ba2);
      animation: waveGlow 3s ease-in-out infinite alternate;
    }

    @keyframes waveGlow {
      0% { stroke-opacity: 0.3; }
      100% { stroke-opacity: 1; }
    }

    /* –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ */
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 12px 20px;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      color: var(--text-color);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.25s ease;
      z-index: 100;
    }

    .back-btn:hover {
      background: var(--accent-color);
      transform: translateX(-3px);
    }

    /* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä */
    .calculator-wrapper {
      max-width: 600px;
      width: 100%;
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      position: relative;
      z-index: 1;
      animation: fadeIn 0.6s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .calculator-header {
      padding: 32px;
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .calculator-header h1 {
      font-size: 1.8rem;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .calculator-header p {
      font-size: 0.95rem;
      opacity: 0.7;
      line-height: 1.5;
    }

    .calculator-body {
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }

    /* Drag and Drop */
    .drop-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(139, 92, 246, 0.95);
      backdrop-filter: blur(8px);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 10;
    }

    .drop-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .drop-content {
      text-align: center;
      animation: dropBounce 0.6s ease;
    }

    .drop-icon {
      font-size: 4rem;
      animation: floatIcon 0.8s ease-in-out infinite alternate;
      margin-bottom: 12px;
    }

    .drop-text {
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
    }

    @keyframes dropBounce {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes floatIcon {
      from { transform: translateY(0); }
      to { transform: translateY(-8px); }
    }

    /* Input –≥—Ä—É–ø–ø–∞ */
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0.9;
    }

    .input-with-icon {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    select, input[type="number"] {
      flex: 1;
      height: 52px;
      padding: 0 16px;
      border-radius: var(--radius);
      background: var(--input-bg);
      color: var(--text-color);
      border: 1.5px solid transparent;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
      appearance: none;
    }

    select {
      background-image: url("data:image/svg+xml,%3Csvg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 20px;
      cursor: pointer;
    }

    select:focus, input[type="number"]:focus {
      border-color: var(--accent-color);
      outline: none;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    .file-icon {
      width: 52px;
      height: 52px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: var(--input-bg);
      border-radius: var(--radius);
      cursor: pointer;
      flex-shrink: 0;
      transition: background 0.25s ease;
      font-size: 20px;
      position: relative;
    }

    .file-icon:hover {
      background: var(--accent-color);
    }

    .hidden {
      display: none !important;
    }

    .loader {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top: 2px solid var(--accent-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tooltip */
    .tooltip-wrapper {
      position: relative;
    }

    .tooltip-bubble {
      position: absolute;
      top: 100%;
      margin-top: 8px;
      right: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 13px;
      padding: 10px 14px;
      border-radius: var(--radius);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 999;
      max-width: 260px;
      word-wrap: break-word;
      line-height: 1.45;
      text-align: left;
      white-space: normal;
      border: 1.5px solid var(--accent-color);
    }

    .tooltip-wrapper:hover .tooltip-bubble {
      opacity: 1;
    }

    /* –ö–Ω–æ–ø–∫–∞ */
    .btn {
      width: 100%;
      padding: 14px 24px;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.05rem;
      font-weight: 700;
      border-radius: var(--radius);
      background: var(--button-bg);
      color: var(--text-color);
      border: none;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      filter: brightness(1.1);
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: scale(0.99);
    }

    /* –†–µ–∑—É–ª—å—Ç–∞—Ç */
    .result-container {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: var(--radius);
      padding: 20px;
      margin-top: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .result-container.fade-slide-in {
      opacity: 1;
      transform: translateY(0);
    }

    .result-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      font-size: 0.95rem;
    }

    .result-row:last-child {
      margin-bottom: 0;
    }

    .result-row .icon {
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .result-row .label {
      font-weight: 600;
      opacity: 0.8;
    }

    .result-row .value {
      margin-left: auto;
      font-weight: 700;
      color: var(--accent-light);
      text-align: right;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--accent-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }

    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      .calculator-header h1 {
        font-size: 1.4rem;
      }

      .calculator-header {
        padding: 24px;
      }

      .calculator-body {
        padding: 24px;
      }

      .back-btn {
        top: 12px;
        left: 12px;
        padding: 10px 16px;
        font-size: 0.9rem;
      }

      .tooltip-bubble {
        max-width: 80vw;
      }
    }

    @media (max-width: 480px) {
      .calculator-header h1 {
        font-size: 1.2rem;
      }

      .calculator-body {
        padding: 20px;
        gap: 16px;
      }

      select, input[type="number"] {
        height: 48px;
        font-size: 0.95rem;
      }

      .file-icon {
        width: 48px;
        height: 48px;
      }

      .btn {
        font-size: 1rem;
        padding: 12px 20px;
      }

      .result-row {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="animated-bg">
    <svg class="wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
      <path d="M0,160L48,144C96,128,192,96,288,90.7C384,85,480,107,576,128C672,149,768,171,864,165.3C960,160,1056,128,1152,122.7C1248,117,1344,139,1392,149.3L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
    </svg>
  </div>

  <a href="/" class="back-btn">‚Üê –ì–ª–∞–≤–Ω–∞—è</a>

  <div class="container">
    <div class="calculator-wrapper">
      <div class="drop-overlay" id="dropOverlay">
        <div class="drop-content">
          <div class="drop-icon">üìÑ</div>
          <div class="drop-text">–û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
        </div>
      </div>

      <div class="calculator-header">
        <h1>üéôÔ∏è –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–∑–≤—É—á–∫–∏</h1>
        <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞</p>
      </div>

      <div class="calculator-body">
        <div class="input-group">
          <label for="serviceSelect">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É</label>
          <div class="input-with-icon">
            <select id="serviceSelect">
              <option value="voice_text">–û–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞</option>
              <option value="voice_video">–û–∑–≤—É—á–∫–∞ –≤–∏–¥–µ–æ</option>
              <option value="translate_text">–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞</option>
              <option value="translate_voice">–ü–µ—Ä–µ–≤–æ–¥ + –æ–∑–≤—É—á–∫–∞ –≤–∏–¥–µ–æ</option>
              <option value="voice_camera">–û–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–∞–º–µ—Ä—É</option>
            </select>
            <div class="file-icon tooltip-wrapper">
              ‚ùì
              <div id="tooltip" class="tooltip-bubble">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div>
            </div>
          </div>
        </div>

        <div class="input-group">
          <label for="manualInput">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <div class="input-with-icon">
            <input type="number" id="manualInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" />
            <div id="fileWrapper" class="file-icon tooltip-wrapper">
              <label id="fileLabel" for="fileInput" style="all: unset; cursor: pointer;">
                <span class="icon">üìé</span>
                <span class="loader hidden"></span>
              </label>
              <div class="tooltip-bubble">–ó–∞–≥—Ä—É–∑–∏—Ç–µ .txt –∏–ª–∏ .docx</div>
            </div>
            <input type="file" id="fileInput" accept=".txt,.docx" style="display: none;" />
          </div>
        </div>

        <button class="btn" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å</button>

        <div id="result"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <script>
  let basePrice = 0;
  let urgent = false;
  
  const manualInput = document.getElementById('manualInput');
  const serviceSelect = document.getElementById('serviceSelect');
  const fileLabel = document.getElementById('fileLabel');
  const urgentBtn = document.getElementById('urgentBtn');
  const resultBlock = document.getElementById('result');
  const serviceTip = document.getElementById('serviceTip');

  manualInput.addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      calculate();
    }
  });

  const serviceTips = {
    "voice_text": "‚ö° –ó–∞–≥—Ä—É–∑–∏—Ç–µ txt –∏–ª–∏ docx, –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –¥–ª—è –æ–∑–≤—É—á–∫–∏. –í—Å–µ —á–∏—Å–ª–∞, —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ –µ–¥–∏–Ω–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Äî —Ç–∞–∫, –∫–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Ö –ø—Ä–æ–∏–∑–Ω–µ—Å–ª–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: 32 –º - —Ç—Ä–∏–¥—Ü–∞—Ç—å –¥–≤–∞ –º–µ—Ç—Ä–∞",
    "voice_video": "‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –Ω–µ–±—Ö–æ–¥–∏–º–æ –≤–≤–æ–¥–∏—Ç—å —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º –≤ –±–æ–ª—å—à—É—é —Å—Ç–µ–ø–µ–Ω—å. 6 –º–∏–Ω—É—Ç 3 —Å–µ–∫—É–Ω–¥—ã => 7 –º–∏–Ω—É—Ç",
    "translate_text": "üìö –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏–ª–∏ –ø–µ—Ä–µ—Ç—è–Ω–∏—Ç–µ —Å—é–¥–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (txt, docx) –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞.",
    "translate_voice": "üåê –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –Ω–µ–±—Ö–æ–¥–∏–º–æ –≤–≤–æ–¥–∏—Ç—å —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º –≤ –±–æ–ª—å—à—É—é —Å—Ç–µ–ø–µ–Ω—å. 6 –º–∏–Ω—É—Ç 3 —Å–µ–∫—É–Ω–¥—ã => 7 –º–∏–Ω—É—Ç",
    "voice_camera": "üìπ –ó–∞–≥—Ä—É–∑–∏—Ç–µ txt –∏–ª–∏ docx, –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –¥–ª—è –æ–∑–≤—É—á–∫–∏. –í—Å–µ —á–∏—Å–ª–∞, —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∏ –µ–¥–∏–Ω–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é ‚Äî —Ç–∞–∫, –∫–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –∏—Ö –ø—Ä–æ–∏–∑–Ω–µ—Å–ª–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: 120 –∫–º ‚Üí —Å—Ç–æ –¥–≤–∞–¥—Ü–∞—Ç—å –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤."
  };
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∏ —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
  function updateUI() {
    const allowFile = ['voice_text', 'translate_text', 'voice_camera'].includes(serviceSelect.value);
    const fileWrapper = document.getElementById("fileWrapper");
    fileWrapper.classList.toggle('hidden', !allowFile);
  
    const ph = {
      'voice_text': '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤',
      'voice_video': '–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ (–º–∏–Ω—É—Ç—ã)',
      'translate_text': '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–Ω–∞–∫–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤',
      'translate_voice': '–í–≤–µ–¥–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ (–º–∏–Ω—É—Ç—ã)',
      'voice_camera': '–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤'
    };
    manualInput.placeholder = ph[serviceSelect.value] || '–í–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é';
    document.getElementById("tooltip").textContent = serviceTips[serviceSelect.value] || "";

  
    urgent = false;
    basePrice = 0;
    urgentBtn.style.display = 'none';
    resultBlock.innerText = '';
    manualInput.value = '';
  }
  
  // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π ---
  serviceSelect.addEventListener('change', updateUI);
  
  manualInput.addEventListener('input', () => {
    urgent = false;
    basePrice = 0;
    urgentBtn.style.display = 'none';
    resultBlock.innerText = '';
  });
  
  document.addEventListener("DOMContentLoaded", updateUI);
  
  // --- DRAG AND DROP ---

const dropZone = document.getElementById('dropZone');
let dragCounter = 0;

window.addEventListener('dragenter', (e) => {
  dragCounter++;
  dropZone.classList.add('active');
});

window.addEventListener('dragleave', (e) => {
  dragCounter--;
  if (dragCounter <= 0) {
    dropZone.classList.remove('active');
  }
});

window.addEventListener('dragover', (e) => {
  e.preventDefault();
});

window.addEventListener('drop', async (e) => {
  e.preventDefault();
  dragCounter = 0;
  dropZone.classList.remove('active');

  const file = e.dataTransfer.files[0];
  if (!file || !['text/plain', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(file.type)) {
    alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .txt –∏ .docx');
    return;
  }

  if (!['voice_text', 'translate_text', 'voice_camera'].includes(serviceSelect.value)) {
    serviceSelect.value = 'voice_text';
    updateUI();
  }

  document.getElementById('fileInput').files = e.dataTransfer.files;
  handleFile({ target: { files: e.dataTransfer.files } });
});

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ ---
  document.getElementById('fileInput').addEventListener('change', handleFile);
  
  function handleFile(e) {
    urgent = false;
    basePrice = 0;
    urgentBtn.style.display = 'none';
    resultBlock.innerText = '';
  
    const file = e.target.files[0];
    if (!file) return;
  
    const icon = fileLabel.querySelector('.icon');
    const loader = fileLabel.querySelector('.loader');
    icon.classList.add('hidden');
    loader.classList.remove('hidden');
  
    const done = async (text) => {
      try {
        const count = await countBackend(text);
        if (!isNaN(count) && count >= 1) {
          manualInput.value = count;
          calculate();  // ‚Üê –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ä–∞—Å—á–µ—Ç–∞
        } else {
          manualInput.value = 0;
          alert("–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤!");
        }
      } catch (err) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ —Å–ª–æ–≤. –ü—Ä–æ–≤–µ—Ä—å —Ñ–∞–π–ª.");
      } finally {
        icon.classList.remove('hidden');
        loader.classList.add('hidden');
      }
    };
  
    const fail = (msg) => {
      icon.classList.remove('hidden');
      loader.classList.add('hidden');
      alert(msg);
    };
  
    if (file.name.endsWith('.txt')) {
  const reader = new FileReader();

  reader.onload = function (event) {
    const text = event.target.result;
    const looksBroken = text.includes(" ") || text.length < 100;

    if (looksBroken) {
      const fallbackReader = new FileReader();
      fallbackReader.onload = function (e) {
        const recoveredText = e.target.result;
        setTimeout(() => done(recoveredText), 500 + Math.random() * 800);
      };
      fallbackReader.onerror = () => fail("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å .txt —Ñ–∞–π–ª (–∫–æ–¥–∏—Ä–æ–≤–∫–∞).");
      fallbackReader.readAsText(file, 'windows-1251');
    } else {
      setTimeout(() => done(text), 500 + Math.random() * 800);
    }
  };

  reader.onerror = () => fail("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å .txt —Ñ–∞–π–ª.");
  reader.readAsText(file);
}


    else if (file.name.endsWith('.docx')) {
      const reader = new FileReader();
      reader.onload = function (event) {
        mammoth.extractRawText({ arrayBuffer: event.target.result })
          .then(result => {
            const text = result.value || '';
            setTimeout(() => done(text), 500 + Math.random() * 800);
          })
          .catch(err => {
            fail("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ .docx —Ñ–∞–π–ª–∞.");
          });
      };
      reader.onerror = () => fail("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å .docx —Ñ–∞–π–ª.");
      reader.readAsArrayBuffer(file);
    } else {
      fail("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã .txt –∏ .docx");
    }
  }
  
  async function countBackend(text) {
  const service = serviceSelect.value;
  const url = service === 'translate_text'
    ? "http://127.0.0.1:8000/count_chars"
    : "http://127.0.0.1:8000/count_words";

  const response = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text, service })  // üëà –≤–æ—Ç —ç—Ç–æ –≤–∞–∂–Ω–æ!
  });

  if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");

  const data = await response.json();
  return service === 'translate_text' ? data.chars : data.words;
}
  
  window.applyUrgent = function applyUrgent() {
    if (!basePrice) return;
    urgent = true;
    calculate();
  }
  
  async function calculate() {
    const service = serviceSelect.value;
    let value = parseInt(manualInput.value) || 0;
  
    if (!value || value <= 0) {
      resultBlock.innerText = "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.";
      return;
    }
  
    // –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞
    resultBlock.innerHTML = `<div class="spinner"></div>
      <div style="margin-top:12px;color:#888;">–°—á–∏—Ç–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å...</div>`;
  
    const payload = {
      service: service,
      text: value.toString(),
      is_urgent: urgent
    };
  
    try {
      const response = await fetch("http://127.0.0.1:8000/calculate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
      const data = await response.json();
  
      function secondsToTime(sec) {
        const m = Math.floor(sec / 60);
        const s = Math.round(sec % 60);
        return `${m}:${s < 10 ? '0' : ''}${s}`;
      }
  
      let serviceTitle = {
        'voice_text': "–û–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞",
        'voice_video': "–û–∑–≤—É—á–∫–∞ –≤–∏–¥–µ–æ",
        'translate_text': "–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞",
        'translate_voice': "–ü–µ—Ä–µ–≤–æ–¥ + –æ–∑–≤—É—á–∫–∞ –≤–∏–¥–µ–æ",
        'voice_camera': "–û–∑–≤—É—á–∫–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–∞–º–µ—Ä—É"
      }[service] || "";
  
      let resultText = `<div class="result-container" style="font-size:18px; line-height:1.6; max-width:400px; margin:0 auto;">`;

// –£—Å–ª—É–≥–∞
resultText += `
  <div class="result-row">
    <div class="icon">üì¶</div>
    <div class="label">–£—Å–ª—É–≥–∞:</div>
    <div class="value">${serviceTitle}${urgent ? " (–°–†–û–ß–ù–û)" : ""}</div>
  </div>
`;

// –°–ª–æ–≤–∞ / –º–∏–Ω—É—Ç—ã / –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ö—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂
if (service === 'voice_text' || service === 'voice_camera') {
  const words = data.word_count;
  const minutes = Math.ceil(words / 120);
  const optimal_time = secondsToTime(Math.round(words * 60 / 133));
  resultText += `
    <div class="result-row">
      <div class="icon">üìÑ</div>
      <div class="label">–°–ª–æ–≤:</div>
      <div class="value">${words}</div>
    </div>
    <div class="result-row">
      <div class="icon">üïí</div>
      <div class="label">–î–æ:</div>
      <div class="value">${minutes} –º–∏–Ω—É—Ç</div>
    </div>
    <div class="result-row">
      <div class="icon">üéØ</div>
      <div class="label">–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ö—Ä–æ–Ω–æ–º–µ—Ç—Ä–∞–∂:</div>
      <div class="value">${optimal_time}</div>
    </div>
  `;
}

// –í–∏–¥–µ–æ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥ + –æ–∑–≤—É—á–∫–∞ –≤–∏–¥–µ–æ ‚Äî –º–∏–Ω—É—Ç—ã
if (service === 'voice_video' || service === 'translate_voice') {
  resultText += `
    <div class="result-row">
      <div class="icon">üïí</div>
      <div class="label">–î–æ:</div>
      <div class="value">${value} –º–∏–Ω—É—Ç</div>
    </div>
  `;
}

// –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ ‚Äî –∑–Ω–∞–∫–∏
if (service === 'translate_text') {
  resultText += `
    <div class="result-row">
      <div class="icon">üî†</div>
      <div class="label">–ó–Ω–∞–∫–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤:</div>
      <div class="value">${value}</div>
    </div>
  `;
}

// –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
const deadline = urgent ? data.deadline_urgent : data.deadline;
const match = deadline.match(/^(.+?) \(–¥–æ (.+?) –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ\)$/);

let daysOnly = '';
if (match?.[1]) {
  const num = parseInt(match[1]);
  if (!isNaN(num)) {
    daysOnly = num === 1 ? '1 –¥–µ–Ω—å' : `–¥–æ ${num} –¥–Ω–µ–π`;
  } else {
    daysOnly = `–¥–æ ${match[1]}`;
  }
}

const dateOnly = match?.[2] || "";

resultText += `
  <div class="result-row">
    <div class="icon">‚è∞</div>
    <div class="label">–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</div>
    <div class="value">${daysOnly}</div>
  </div>
  <div class="result-row">
    <div class="icon">üìÖ</div>
    <div class="label">–î–µ–¥–ª–∞–π–Ω:</div>
    <div class="value">${dateOnly}</div>
  </div>
`;

// –°—Ç–æ–∏–º–æ—Å—Ç—å
resultText += `
  <div class="result-row">
    <div class="icon">üí∞</div>
    <div class="label">–°—Ç–æ–∏–º–æ—Å—Ç—å:</div>
    <div class="value">${
      urgent
        ? `${data.price_rub.toLocaleString('ru-RU')} ‚ÇΩ ‚û°Ô∏è ${data.price_rub_urgent.toLocaleString('ru-RU')} ‚ÇΩ`
        : `${data.price_rub.toLocaleString('ru-RU')} ‚ÇΩ`
    }</div>
  </div>
`;

// –í USDT
resultText += `
  <div class="result-row">
    <div class="icon">üí≤</div>
    <div class="label">–í USDT:</div>
    <div class="value">${
      urgent
        ? `${data.price_usdt} USDT ‚û°Ô∏è ${data.price_usdt_urgent} USDT`
        : `${data.price_usdt} USDT`
    }</div>
  </div>
`;

resultText += `</div>`;

setTimeout(() => {
  resultBlock.innerHTML = resultText;
  requestAnimationFrame(() => {
  const container = resultBlock.querySelector('.result-container');
  if (container) container.classList.add('fade-slide-in');
  });

  if (!urgent) {
    basePrice = data.price_rub;
    urgentBtn.style.display = 'block';
  } else {
    urgentBtn.style.display = 'none';
  }
}, 600 + Math.random() * 400);

} catch (error) {
  resultBlock.innerText = "–û—à–∏–±–∫–∞: " + error.message;
}
  }

</script>
</body>
</html>